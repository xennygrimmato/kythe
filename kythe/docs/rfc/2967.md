## Build Configuration in the Kythe Graph

## Objective

Incorporate build configuration information into the Kythe graph. Somewhat
relatedly, provide canonical guidelines on how to identify build-time generated
artifacts.

## Background

Currently, the Kythe graph largely assumes that it is built for a single
configuration, at a consistent revision for a particular corpus. Historically,
this has worked well. But as time marches onward and the diversity of platforms
built from a single corpus has grown it has left a widening gap in the
information available to users with only partial cross references for some files
(due to conditional compilation) or other files entirely omitted due to
build-time selection. In order to work around this lack, some third-party
corpora (most notably Chromium) have begun to use the "root" VName field to
encode this information. Similarly, the extant "prodkernel" corpus has need of
this, but currently makes do without. We reasonably anticipate that other
soon-to-be-corpora such as Android and Tensorflow would encounter similar
limitations.

Users need to be able to both filter cross references by a particular build
configuration, but also easily and efficiently see all cross references to a
particular entity regardless of platform. These combined constraints suggest
that incorporating build configuration into a single graph is the correct
solution, rather than relying on a multiplexing layer to merge results from
distinct, per-build, graphs.

Additionally, it's currently possible for cross-references which depend on build
configuration (C++ incorporates equivalent information via the "compiler trace")
to be included in the same graph, as these differences are not exposed directly
the resulting anchors to apparently distinct entities can fail to unify
correctly resulting in user confusion. This will allow those differences to be
expressed or suppressed directly, increasing accessibility.

## Overview

Rather than introduce any new VName fields, nodes or edges build configuration
can be adequately represented via a signature-relevant fact on anchor nodes and
some ancillary clarifications to the guidelines for root and corpus. This is
predicated on:

1.  Non-generated source files exist independent of build configuration.
1.  Nodes must already incorporate relevant information into their signature.
    This includes any elements related to build-configuration which materially
    alters the represented entity. This is currently already done by non-anchor
    (aka "semantic") nodes, but build configuration has not been considered
    relevant for anchors.
1.  Certain languages will necessarily emit different anchors under different
    build configurations (C/C++ are particularly subject to this).
1.  Generated source files must incorporate the build configuration into root in
    some fashion, if the content of the generated files depends on the
    configuration. This is a clarification of the current requirement that file
    nodes omit the signature field and that each unique node have a unique
    vname.
1.  The relevant information should be in a form which is readily available for
    filtering and display.

The end result is that build configuration is most tightly bound to anchors both
semantically and practically. This design also allows for including references
to entities regardless of build configuration as well as filtering only
references for a particular set. Indexers for which build configuration is
irrelevant may omit the fact.

## Detailed Design

### Graph

The Kythe graph will be augmented such that:

1.  File nodes with a non-empty root VName field are explicitly considered to
    have been generated by the build. If the contents of generated files differ
    with the build configuration, the root must include a unique string per
    build configuration. This follows from the general requirements that unique
    graph entities be given unique VNames. This allows clients to trivially know
    if they should request the source for a particular file from the underlying
    repository or from Kythe.
1.  Corpus represents a stable name to a particular logical body of code.
    Different corpus names may map to different parts of the same underlying
    repository. That mapping resides outside the Kythe graph[^1]. In particular,
    this can be used to accommodate source code which resides in a particular
    repository, but is logically distinct from the primary corpus (perhaps due
    to using a different build system). For example, within Piper the primary
    corpus is "google3" but the source code for several languages' standard
    library resides in third_party. Java, C++, and Go use distinct corpora
    for these references.

1.  A new fact "build/config" will be allowed primarily on anchor nodes. This
    should be a stable, user-meaningful string representation of all relevant
    build characteristics (think "android" not "-DHAVE_GLIB"). Generated files
    whose contents depends on the build configuration may also include this fact
    (in addition to their root) to make information more easily discoverable.

1.  As we expect distinct anchors at the same position, this fact must be
    incorporated into the anchor signature by the indexer when present.

### Extraction and Indexing

As build configuration is a high-level description of a build, but must be
incorporated into anchors by the indexer, it must be provided or derived at
build time and incorporated into each resulting CompilationUnit. This will be
done by adding a string-value "build_config" field to
the[kythe.proto.BuildDetails](https://github.com/kythe/kythe/blob/master/kythe/proto/buildinfo.proto)
message. Indexers must incorporate this field into emitted anchors if the
language in question makes a meaningful distinction between build
configurations. This is primarily relevant to C/C++ family languages, but is up
to the individual language indexers to make this determination. When in doubt,
it is recommended that these behavior be flag controlled.

### Post-processing

The post processor will collect the build configurations facts and emit them for
use by the StatusService. (TODO(#3322))

### Serving

The available build configurations will be made available via StatusService.
(TODO(#3322))

## Notes

[^1]: For the time being. Keeping this external to the graph is not necessary,
    but not addressed here.
